# 運用メモ（Agents 向け）

本プロジェクトは以下の卒業研究テーマを実施するための環境・スクリプトを扱います。

**テーマ**:「小型移動ロボットにおける VLM ダイレクト制御とハイブリッド制御の比較評価」  
**サブタイトル案**:「OSOYOO ラズパイロボットカーと smolVLM を用いたターゲット到達タスクでの実験的検討」

## 想定する研究タスクと要件

- カメラ付き OSOYOO ロボットカーを LAN 内の Mac/PC から制御し、軽量 VLM（smolVLM2-mlx）でターゲット認識／行動決定を行う。
- 比較対象は以下 2 系統（任意でクラシカル画像処理も追加可）。
  - **条件A: VLM ダイレクト制御** … VLM が `LEFT/RIGHT/FORWARD/STOP` など次の行動を直接決める。
  - **条件B: VLM 認識＋ルール制御** … VLM には「ターゲット位置（LEFT/CENTER/RIGHT）」「距離（FAR/MID/NEAR）」のみ答えさせ、行動はルールで決定。
- タスクは「複数物体の中から指定物体（黄色の箱で正面に TARGET と書かれたもの）の前まで自律移動し停止する」。
- 評価指標: 成功率、平均到達時間、コマンド切り替えの安定性（反転回数等）。
- 曖昧指示・照明変化などを加えてロバスト性を追加評価しても良い。
- これらを通じて「VLM をどのレイヤーまで信頼できるか」「軽量構成での実用限界」を示す。

## 運用ルール

1. **言語**  
   - すべてのログ・コミットメッセージ・README 追記は原則日本語で記述する。
2. **アーキテクチャ**  
   - 研究タスクは 8080 番の `raspi_agent.py` を常駐させる構成を基本とし、Lesson 6 (`camera.sh`, `startcam.py`, `picar4.sh`, `webcar.py`) は必要に応じて互換用として起動する。  
   - PC 側は `pc_controller_direct.py`（条件A）と `pc_controller_hybrid.py`（条件B）を利用し、同じターゲット到達タスクで比較する。  
   - 旧 ESP32-CAM / WebSocket 互換コードは使用禁止。
3. **通信設定**  
   - 映像: `http://<PiのIP>:8899/stream.mjpg`（教材）、または `http://<PiのIP>:8080/frame.jpg` / `/stream.mjpg`（raspi_agent）。
   - 制御: `http://<PiのIP>:5000/?action=command&...`（教材 Flask）または `http://<PiのIP>:8080/command`（raspi_agent）。
   - 研究計測中は `AGENT_URL` を環境変数に設定し、Makefile ターゲット (`pc-direct` / `pc-hybrid`) を用いる。
   - 現在 (2025-11-12) の Pi IP: **自宅 `192.168.0.13` / 研究室 `192.168.11.11`**。自宅側が DHCP で一時的に `192.168.0.26` になる場合は `env.home.26.sh` を使用する。IP を変更した場合は README と本ファイルの両方を更新すること。
4. **安全運用・ログ**  
   - 開発時は DEBUG ログで VLM 応答・送信コマンドを必ず記録し、実験シートに転記。  
   - WATCHDOG（raspi_agent の 2 秒タイムアウト）で停止する構成を維持し、実空間では常に STOP コマンド即時送出の準備をする。

更新時は上記テーマや運用ルールの変更・補足理由と日付を追記してください。

---

## 更新履歴

- 2025-11-19: raspi_agent の `COMMAND_VECTORS` を調整し、前進時の左流れ補正と微小な左右補正（少し左/少し右のアーク移動）を実装。`FORWARD`/`FORWARD_SLOW` の出力を下げて細かい前進ができるようにした。
- 2025-11-19: smolVLM 純VLM評価で検出失敗が続いた経緯を残しつつ、外部 ChatGPT VLM（gpt-5.1-mini）を使うための新スクリプト `pc_vlm_debug_gpt.py` を追加。既存 `pc_vlm_debug.py` は記録用に保持。
- 2025-11-18: 自宅 Pi が 192.168.0.26 になるケースに備え、`env.home.26.sh` を追加。
- 2025-11-16: 自宅側の静的 IP を 192.168.0.13 に変更。README の例と env.home.sh を更新。
- 2025-11-12: 自宅=192.168.0.12、研究室=192.168.11.11 の静的 IP と、raspi_agent (8080) を主経路にする運用を追記。
- 2025-11-11: 卒研テーマ概要・A/B 比較要件を追記。Pi IP を 192.168.0.12 に更新。
- 2025-11-10: Raspberry Pi の固定 IP を 192.168.11.4 に変更したため、カメラ／制御 URL の記載を更新。
- 2025-11-18: smolVLM2-mlx (500M) を純VLMモードで検証したが、TARGET 箱が近距離で画面の約8%を占める状況でも `UNVISIBLE/NONE` 連発となり、位置・距離の安定推定が困難だった。ColorGuard＋ルール制御では補正可能だが、純VLM単独では実験目的を満たさないため「失敗ケース」として記録し、精度確保は ChatGPT VLM など外部モデル併用方針とする。
